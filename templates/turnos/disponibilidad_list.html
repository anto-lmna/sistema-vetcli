{% extends 'base.html' %}
{% load django_bootstrap5 %}

{% block title %}Mis Disponibilidades{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        <h2 class="fw-bold mb-0">🩺 Mis Disponibilidades</h2>
        <a href="{% url 'turnos:nueva_disponibilidad' %}" class="btn btn-primary">
            ➕ Nueva Disponibilidad
        </a>
    </div>

    <!-- Barra de filtros -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body d-flex flex-wrap justify-content-between align-items-center gap-3">
            <div class="btn-group" role="group">
                <a href="?filtro=futuras" 
                   class="btn {% if filtro_actual == 'futuras' %}btn-primary{% else %}btn-outline-primary{% endif %} btn-sm">
                    📅 Futuras
                </a>
                <a href="?filtro=pasadas" 
                   class="btn {% if filtro_actual == 'pasadas' %}btn-primary{% else %}btn-outline-primary{% endif %} btn-sm">
                    🕓 Pasadas
                </a>
            </div>
            <form method="get" class="d-flex align-items-center gap-2">
                <input type="hidden" name="filtro" value="{{ filtro_actual }}">
                <input type="date" name="buscar_fecha" 
                       value="{{ request.GET.buscar_fecha|default:'' }}"
                       class="form-control form-control-sm" style="max-width: 160px;">
                <button type="submit" class="btn btn-outline-secondary btn-sm">Buscar</button>
            </form>
        </div>
    </div>

    {% if disponibilidades %}
    <div class="card shadow-sm">
        <div class="card-body p-0">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>📅 Rango de Fechas</th>
                        <th>🕒 Horario</th>
                        <th>⏱️ Duración</th>
                        <th>📋 Turnos generados</th>
                        <th>✅ Reservados</th>
                        <th>⚙️ Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for disp in disponibilidades %}
                    <tr>
                        <td>
                            <span class="fw-semibold">{{ disp.fecha_inicio|date:"d/m/Y" }}</span> → 
                            <span class="fw-semibold">{{ disp.fecha_fin|date:"d/m/Y" }}</span>
                        </td>
                        <td>{{ disp.hora_inicio|time:"H:i" }} - {{ disp.hora_fin|time:"H:i" }}</td>
                        <td>{{ disp.duracion_turno }} min</td>

                        <td class="text-primary fw-semibold">{{ disp.turnos_generados.count }}</td>
                        <td class="{% if disp.turnos_reservados.count > 0 %}text-success{% else %}text-muted{% endif %}">
                            {{ disp.turnos_reservados.count }}
                        </td>

                        <td>
                            {% if disp.turnos_reservados.count == 0 %}
                                <a href="{% url 'turnos:eliminar_disponibilidad' disp.id %}"
                                   class="btn btn-outline-danger btn-sm">
                                   🗑️ Eliminar
                                </a>
                            {% else %}
                                <span class="badge bg-secondary">Bloqueada</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <!-- Estado: sin resultados -->
    <div class="text-center text-muted py-5">
        <img src="https://cdn-icons-png.flaticon.com/512/3556/3556279.png" width="70" class="mb-3 opacity-75">
        <p class="fs-5 mb-2">
            {% if filtro_actual == 'pasadas' %}
                No hay disponibilidades pasadas.
            {% else %}
                No hay disponibilidades futuras registradas.
            {% endif %}
        </p>
        <a href="{% url 'turnos:nueva_disponibilidad' %}" class="btn btn-outline-primary btn-sm">
            ➕ Crear una nueva disponibilidad
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}
